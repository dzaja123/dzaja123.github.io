name: Build and Deploy

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v2

      - name: Replace Access Key 🔑
        env:
          ACCESS_KEY: ${{ secrets.ACCESS_KEY }}
        run: |
          sed -i 's/__ACCESS_KEY__/'"$ACCESS_KEY"'/g' index.html

      - name: Fetch pinned repositories 📦
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
        run: |
          curl -H "Authorization: Bearer $GITHUB_TOKEN" \
               -X POST \
               -d '{"query":"{user(login: \"dzaja123\"){pinnedItems(first: 6, types: REPOSITORY) { edges { node { ... on Repository { name description primaryLanguage { name } url }}}}}}"}' \
               https://api.github.com/graphql \
               > json/pinned_repos.json

      - name: Commit updated files 📝
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "GitHub Actions"
          git fetch origin  # Fetch the latest branches
          git checkout gh-pages || git checkout -b gh-pages  # Checkout to gh-pages or create it if it doesn't exist
          git add .  # Stage all changes
          git commit -m "Update pinned repositories and index.html" || echo "No changes to commit"  # Commit if there are changes
          git stash  # Stash any local changes
          git pull origin gh-pages --rebase  # Rebase local changes with remote
          git push origin gh-pages  # Push changes to gh-pages branch

      - name: Deploy 🚀
        uses: JamesIves/github-pages-deploy-action@4.1.4
        with:
          branch: gh-pages  # Deploy to the gh-pages branch
          folder: .  # Deploy the root directory
          token: ${{ secrets.PAT }}
